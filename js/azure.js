var allnews = [{
    "headline": "Sandmännchen und Stasi-Mikrofone",
    "news_id": "k3",
    "short": "Das größte Museum für DDR-Design steht ausgerechnet in Los Angeles. Ein Buch über das Wende Museum zeigt, welche Schätze und Abgründe es dort zu entdecken gibt.",
    "date": "10. November 2014 um 18:25 Uhr",
    "img": "img/ddr-artefakte-alltag-fs-teaser-2-220x124.jpg"
}, {
    "headline": "Mozarts Triptychon",
    "news_id": "k1",
    "short": "Nikolaus Harnoncourt ist der Detektiv unter den Dirigenten. Jetzt legt er Indizien vor, wie drei von Mozarts Sinfonien zu einem nie gehörten Oratorium verschmelzen.",
    "date": "11. November 2014  10:14 Uhr",
    "img": "img/nikolaus-harnoncourt-220x124.jpg"
}, {
    "headline": "Klare Ansage aus Harlem",
    "news_id": "k4",
    "short": "Erst galt Azealia Banks als großes Raptalent, dann als streitsüchtig und selbstverliebt. Ihr seit Jahren erwartetes Debüt zeigt jetzt, wie gut das eine zum anderen passt. ",
    "date": "10. November 2014 um 15:25 Uhr",
    "img": "img/azealia-banks-220x124.jpg"
}, {
    "headline": "Der Unerschütterliche",
    "news_id": "k2",
    "short": "Hans Magnus Enzensberger wird 85. Ein Besuch bei dem herrlich eigenwilligen Intellektuellen. Mit Tumult hat er gerade ein erstaunlich persönliches Buch veröffentlicht.",
    "date": "11. November 2014  06:39 Uhr",
    "img": "img/hans-magnus-enzensberger-220x124.jpg"
}, {
    "headline": "Ein bisschen multimedial",
    "news_id": "k5",
    "short": "Den Krimi gibt es im TV, den Hintergrund im Netz: Zum zweiten Mal ermitteln die Zuschauer von Dina Foxx im ZDF crossmedial. Doch die Website ist diesmal nur ein Bonus.",
    "date": "10. November 2014 um 15:48 Uhr",
    "img": "img/dina-foxx-zdf-220x124.jpg"
}, {
    "headline": "Nur nicht abkühlen, nur nicht komisch werden!",
    "news_id": "k6",
    "short": "Der Tausendseiter ist fertig, der Kumpel ein Tölpel, der über eine öde Hupe schluchzt. Vor lauter Schreck kauft unser Autor tütenweise Haushaltsreiniger.",
    "date": "10. November 2014 um 11:56",
    "img": "img/feridun-zaimoglu-freitext-teaser-220x124.jpg"
}, {
    "headline": "Der Pimmel ist ein Schoßhündchen",
    "news_id": "k7",
    "short": "Souverän gemeißelte Syntax, hin und wieder eine kleine Obszönität: Der Literaturwettbewerb Open Mike war ein Schaulaufen für erschreckend professionelle Jungautoren.",
    "date": "10. November 2014  11:51 Uhr",
    "img": "img/open-mike-2014-2-220x124.jpg"
}, {
    "headline": "Barockes Teufelsfratzenpanorama",
    "news_id": "k8",
    "short": "Versüßt und versülzt: Frank Castorf verkitscht in seinem Stück \"Kaputt\" an der Berliner Volksbühne die Weltkriegsfantasien von Curzio Malaparte.",
    "date": "10. November 2014  11:13 Uhr",
    "img": "img/castorf-kaputt-volksbuehne-220x124.jpg"
}, {
    "headline": "Es bleibt ein Kampf",
    "news_id": "k9",
    "short": "Wie Politik und Bürger um Menschenrechte ringen: Jan Eckels monumentale Studie \"Die Ambivalenz des Guten\"",
    "date": "9. November 2014  21:20 Uhr",
    "img": "img/demonstranten-chile-220x124.jpg"
}, {
    "headline": "Pose für mich!",
    "news_id": "k10",
    "short": "Voguing ist ein Tanz, der sich aus Modelposen der Illustrierten zusammensetzt. Warum ist er derzeit so populär?",
    "date": "8. November 2014  19:02 Uhr",
    "img": "img/voguing-unicorn-ball-220x124.jpg"
}, {
    "headline": "Renten könnten 2015 um zwei Prozent steigen",
    "news_id": "p5",
    "short": "Die Deutsche Rentenversicherung geht von einem Anstieg über der Inflationsrate aus. Abschlagsfreie Rente ab 63 Jahren stößt auf großes Interesse.",
    "date": "11. November 2014  12:42 Uhr",
    "img": "img/rentner-220x124.jpg"
}, {
    "headline": "Deutschland darf EU-Ausländern Hartz IV verweigern",
    "news_id": "p6",
    "short": "Der Europäische Gerichtshof hat entschieden: Deutschland kann arbeitslose Zuwanderer aus der EU von Sozialleistungen ausschließen. Das Urteil könnte ein Signal sein.",
    "date": "11. November 2014  10:05 Uhr",
    "img": "img/europaeischer-gerichtshof-hartz-220x124.jpg"
}, {
    "headline": "Obama besänftigt China",
    "news_id": "p1",
    "short": "Die USA wollen China nicht klein halten, sagt Präsident Obama vor dem Treffen mit Chinas Staatschef Xi. Der plädiert für mehr wirtschaftliche Verflechtung.",
    "date": "11. November 2014  06:48 Uhr",
    "img": "img/obam-xi-apec-2-220x124.jpg"
}, {
    "headline": "Die alte Kolonialmacht versucht es mit Diskretion",
    "news_id": "p3",
    "short": "Ob gestürzte Präsidenten oder Anti-Terror-Kampf: Frankreich beeinflusst noch immer die Geschicke Afrikas. Diskret ist die Ex-Kolonialmacht auch mit mehr Truppen präsent.",
    "date": "10. November 2014 um 18:15 Uhr",
    "img": "img/zentralfrika-frankreich-truppen-220x124.jpg"
}, {
    "headline": "Keiner will von Intifada sprechen",
    "news_id": "p2",
    "short": "Messerattacken auf Israelis, Krawalle auf dem Tempelberg, Scharmützel im Gassengewirr Jerusalems. Israels Polizei bereitet sich auf einen Aufstand der Palästinenser vor.",
    "date": "10. November 2014  19:17 Uhr",
    "img": "img/israel-anschlag-220x124.jpg"
}, {
    "headline": "Russland und der Westen riskieren militärische Eskalation",
    "news_id": "p4",
    "short": "Beinahe-Zusammenstöße in der Luft und auf dem Wasser, aggressives militärisches Auftreten: Laut einem Bericht stand eine Eskalation in diesem Jahr mehrmals kurz bevor.",
    "date": "10. November 2014  16:48 Uhr",
    "img": "img/russland-kampfjet-220x124.jpg"
}, {
    "headline": "Der Anti-Sarkozy-Komplott",
    "news_id": "p7",
    "short": "Dem früheren Premier Fillon und Parteifreund des Ex-Präsidenten wird vorgeworfen, gegen Sarkozy intrigiert zu haben. Versuchte er, dessen Comeback zu verhindern?",
    "date": "10. November 2014  17:53 Uhr",
    "img": "img/sarkozy-jouyet-220x124.jpg"
}, {
    "headline": "Messerattacken schüren Angst vor neuer Intifada",
    "news_id": "p8",
    "short": "Im Westjordanland hat ein Palästinenser eine junge Siedlerin erstochen. In Tel Aviv wurde ein Soldat verletzt. Israel fürchtet einen neuen Aufstand der Palästinenser.",
    "date": "10. November 2014  16:34 Uhr",
    "img": "img/anschlag-tel-aviv-220x124.jpg"
}, {
    "headline": "Der Westen und sein Stasi-Problem",
    "news_id": "p9",
    "short": "Bis heute arbeitet Ex-IM Görlich an der Uni Braunschweig. Nicht er, sondern das Opfer seiner Bespitzelung hat nach Bekanntwerden der Stasi-Geschichte die Uni verlassen. ",
    "date": "10. November 2014  18:30 Uhr",
    "img": "img/stasiakten-220x124.jpg"
}, {
    "headline": "Neuer BdV-Präsident bezeichnet Vertreibung aus Polen als Verbrechen",
    "news_id": "p10",
    "short": "Bernd Fabritius will das Verhältnis zu Polen entspannen. Die Vertreibung von Millionen Deutschen hat der Nachfolger von Erika Steinbach dennoch aufs Schärfste verurteilt. ",
    "date": "10. November 2014  18:03 Uhr",
    "img": "img/bernd-fabritius-220x124.jpg"
}, {
    "headline": "Guter Rat zur Geldanlage ist selten",
    "news_id": "w1",
    "short": "Honorarberatung ist in Deutschland endlich gesetzlich geregelt. Doch gibt es kaum Honorarberater. Und gut qualifizierte noch viel weniger.",
    "date": "11. November 2014  07:15 Uhr",
    "img": "img/geldanlage-honorarberatung-220x124.jpg"
}, {
    "headline": "Der berühmteste Wohltäter Chinas – nach eigenen Angaben",
    "news_id": "w2",
    "short": "Der chinesische Unternehmer Chen Guangbiao wurde ausgerechnet mit Bauschutt sehr reich. Jetzt baut er Wände aus GelDBündeln und zertrümmert öffentlich Luxusautos.",
    "date": "10. November 2014  21:32 Uhr",
    "img": "img/china-chen-guangbiao-220x124.jpg"
}, {
    "headline": "Middelhoff, der selbstlose Super-Manager",
    "news_id": "w5",
    "short": "Ende der Woche könnte das Urteil gegen Thomas Middelhoff fallen. Seine Anwälte stilisieren den Ex-Arcandor-Chef als Opfer: Er habe nur gearbeitet und geschlafen.",
    "date": "10. November 2014  14:15 Uhr",
    "img": "img/thomas-middelhoff-220x124.jpg"
}, {
    "headline": "China steckt in der Wachstumsfalle",
    "news_id": "w3",
    "short": "Jahrelang hat China die Welt mit hohen, oft zweistelligen Wachstumsraten beeindruckt. Doch diese Zeiten sind vorbei, wie unsere Grafik des Tages zeigt. ",
    "date": "10. November 2014  19:29 Uhr",
    "img": "img/konjunktur-china-220x124.jpg"
}, {
    "headline": "Russlands Zentralbank lässt Rubel frei handeln",
    "news_id": "w4",
    "short": "Die Notenbank will dem Verfall der russischen Währung mit neuen Mitteln begegnen. Sie gibt den Wechselkurs frei und begrenzt die täglichen Devisenkäufe.",
    "date": "10. November 2014  13:45 Uhr",
    "img": "img/russland-zentralbank-rubel-220x124.jpg"
}, {
    "headline": "Initiative zieht wegen TTIP vor Europäischen Gerichtshof",
    "news_id": "w6",
    "short": "Eine Allianz aus Bürgerverbänden gegen das Freihandelsabkommen will ihre Anerkennung durch die EU juristisch erzwingen. Es geht um mehr Bürgerbeteiligung.",
    "date": "10. November 2014  11:53 Uhr",
    "img": "img/ttip-protest-220x124.jpg"
}, {
    "headline": "Die Globalisierung wird zum Elitenprojekt",
    "news_id": "w7",
    "short": "Der Unmut der Bürger über das Freihandelsabkommen TTIP und die Globalisierung wächst. Eine weltweite Abgabe für Banken und Hedgefonds könnte den Widerstand brechen.",
    "date": "10. November 2014  07:15 Uhr",
    "img": "img/globalisierung-ungleichheit-220x124.jpg"
}, {
    "headline": "Die Streikkasse gefüllt, die Reihen geschlossen",
    "news_id": "w9",
    "short": "Die Gegner des GDL-Chefs Klaus Weselsky berichten von Unzufriedenheit in der Gewerkschaft. Doch die hohe Streikbeteiligung zeigt: Sein harter Kurs hat Unterstützung.",
    "date": "6. November 2014  21:49 Uhr",
    "img": "img/gdl-bahn-streik-claus-weselsky-220x124.jpg"
}, {
    "headline": "Vorsicht, Schlussverkauf!",
    "news_id": "w8",
    "short": "Die meisten Anlageprodukte sind teuer, und zwar bevor das Geld des Sparers überhaupt anfängt zu arbeiten.",
    "date": "10. November 2014  11:53 Uhr",
    "img": "img/lebensversicherung-220x124.jpg"
}, {
    "headline": "'Wird man krank, wird man einfach aussortiert'",
    "news_id": "w10",
    "short": "Recherchen von ZEIT ONLINE zeigten: Auch die neue Wachfirma in den Flüchtlingsheimen in Burbach und Essen hat große interne Probleme. Nun erheben Wachleute neue Vorwürfe.",
    "date": "7. November 2014  07:24 Uhr",
    "img": "img/sicherheitsfirma-220x124.jpg"
}]

var streamsData = {
    "kultur": {
        "title": "Kultur", 
        "news": ["k3", "k1", "k4", "k2", "k5", "k6", "k7", "k8", "k9", "k10"]
    },
    "politik": {
        "title": "Politik", 
        "news": ["p5", "p6", "p1", "p3", "p2", "p4", "p7", "p8", "p9", "p10"]
    },
    "wirtschaft": {
        "title": "Wirtschaft",
        "news": ["w1", "w2", "w5", "w3", "w4", "w6", "w7", "w9", "w8", "w10"]
    }
}

var er = function(error) {
    console.error('error', error);
};

var s = function(success) {
    console.log('success', success);
};

function all(promises) {
    var results = [];
    return promises.reduce(function(left, right) {
        return left.then(function(result) {
            results.push(result);
            return right;
        }, er);
    }).then(function(last) {
        results.push(last);
        return results;
    }, er);
}

function connect() {
    return new WindowsAzure.MobileServiceClient("https://bq-news.azure-mobile.net/", "bpBdrIYXmOJuDeDylwgBsaFAFSDlax89");
}

function insert(client) {
    streams = client.getTable('streams');
    news = client.getTable('news');

    var promises = [];
    $.each(streamsData, function(key, value) {
        value.news = JSON.stringify(value.news);
        promises.push(streams.insert(value).then(s, er));
    });

    allnews.forEach(function(elem) {
        promises.push(news.insert(elem).then(s, er));
    });

    return all(promises);
}

function load(client) {
    streams = client.getTable('streams');
    news = client.getTable('news');

    streams.read().done(function(result) {
        result.forEach(function(stream) {
            var news_array = JSON.parse(stream.news);
            news_array.forEach(function(id) {
                render(stream.title, news.where({
                    "news_id": id
                }).read().then(function(r) {return r[0];}));
            });
        });
    });
}

var client = connect();
~location.search.indexOf("init=true")? insert(client): load(client);